#!/bin/bash

# Tags: very-slow

set -e
set -u

source ./api/pipeline.sh


CONVERT_FASTA_TO_TAB=./opt/misc-bioinfo-scripts/convert-fasta-to-tab 

LATEST_CDD_TAR=`ls -1d ./data/cdd-*/fasta.tar.gz | sort | tail -1`
DATA_IN1="$0-data-in/fasta.tar.gz-extracted"
DATA_OUT="$0-data-out"

mkdir -p $DATA_IN1 $DATA_OUT 2> /dev/null && true

TIMEFORMAT="%0lR
" # When timing, print no-fraction, long-format, elapsed time, and a linebreak


# 12 min
function cb {
    mkdir -p $DATA_IN1{,-new} 2> /dev/null && true
    tar xf $LATEST_CDD_TAR -C $DATA_IN1-new
    rm -rf $DATA_IN1
    mv $DATA_IN1{-new,}
}
parrent_done_time_prefix=$LATEST_CDD_TAR
done_time_prefix=$DATA_IN1
pipeline   $parrent_done_time_prefix   $done_time_prefix \
  "Extracting $LATEST_CDD_TAR" cb


# 11 min
function cb {
    mkdir -p $DATA_OUT/all-alignments-tab{,-new} 2> /dev/null && true
    ls $DATA_IN1 | 
      while read i; do
        cat $DATA_IN1/$i | $CONVERT_FASTA_TO_TAB > \
          $DATA_OUT/all-alignments-tab-new/$i.tab
      done
    rm -rf $DATA_OUT/all-alignments-tab
    mv $DATA_OUT/all-alignments-tab{-new,}
}
parrent_done_time_prefix=$done_time_prefix
done_time_prefix=$DATA_OUT/all-alignments-tab
pipeline   $parrent_done_time_prefix   $done_time_prefix \
  "Converting FASTA to TAB: $DATA_IN1 to $DATA_OUT/all-alignments-tab" cb


# 12 min
function cb {
    echo "Listing alignments"
    ls -1 $DATA_OUT/all-alignments-tab/ > $DATA_OUT/msa-list-new
    mv $DATA_OUT/msa-list-new $DATA_OUT/msa-list

    echo "Counting sequences"
    cat $DATA_OUT/msa-list | 
      while read i; do
        cat $DATA_OUT/all-alignments-tab/$i | wc -l | tr "\n" "\t"
        echo $i
      done > $DATA_OUT/msa-sizes-numseq-new
    mv $DATA_OUT/msa-sizes-numseq-new $DATA_OUT/msa-sizes-numseq

    echo "Counting msa lengths"
    cat $DATA_OUT/msa-list | 
      while read i; do 
        head -1 $DATA_OUT/all-alignments-tab/$i |
          awk '{print $2}' | tr -d "\n" | wc -c | tr "\n" "\t"
        echo $i
      done > $DATA_OUT/msa-sizes-length-new
    mv $DATA_OUT/msa-sizes-length-new $DATA_OUT/msa-sizes-length
}
parrent_done_time_prefix=$done_time_prefix
done_time_prefix=$DATA_OUT
pipeline   $parrent_done_time_prefix   $done_time_prefix \
  "Indexing $DATA_OUT/all-alignments-tab" cb  
