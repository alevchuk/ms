#!/bin/bash

# UNNAMED is a classifier of outlier sequences in multiple alignments
# Copyright (C) 2011  Aleksandr Levchuk
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


set -e
set -u

DATA_OUT="$0-data-out"
mkdir -p $DATA_OUT-new 2> /dev/null && true

SCORE_FILES=`echo \
  010-run-guidance-data-out/sample*-list-nogaps/*/MSA.MAFFT.Guidance_msa.scr |
  tr " " "\n" |
  grep -v with-random |
  tr "\n" " "`

# If these files exists then *'s will expand
if [[ $SCORE_FILES =~ \* ]]; then
  echo "$0: ERROR: Could not find score files $SCORE_FILES" >&2
  echo "Did you run the tasks generated by 010-run-guidance?" >&2
  exit 1
fi

grep "MEAN_RES_PAIR_SCORE" $SCORE_FILES | while read line; do

    sample=`echo $line |
     awk -F"/" '{print $2}' | # Parse directory structure
     awk -F- '{print $1 "-" $2 "-" $3}' # Parse file name structure
    `

    echo $line |
      awk '{print $1, $4}' | # $2 is MEAN_RES_PAIR_SCORE, $4 is MEAN_COL_SCORE
      awk -F/ '{print $3, $4}' |
      awk '{print $1 "\t" $3}' |
      cat >> $DATA_OUT-new/$sample-mafft-guidance-msa-scr

   done

for i in $DATA_OUT-new/*-mafft-guidance-msa-scr; do
  sort -nk 2 $i > $i-new
  mv $i{-new,}
done


# Danger Zone
rm -rf $DATA_OUT

# Done
mv $DATA_OUT{-new,}


wc -l 014-get-scores-data-out/*
